apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Staging Environment Backup Overlay
# Backup paths:
#   - PostgreSQL: /staging-goapps-backup/postgres
#   - MinIO: /staging-goapps-backup/minio

namespace: database

resources:
  - ../../../base/backup

patches:
  # ===== PostgreSQL Backup Patches =====
  # Patch backup path for staging VPS - Morning backup
  - target:
      kind: CronJob
      name: postgres-backup-morning
    patch: |-
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/env/0/value
        value: "staging"
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/volumes/0/hostPath/path
        value: "/staging-goapps-backup/postgres"

  # Patch backup path for staging VPS - Afternoon backup
  - target:
      kind: CronJob
      name: postgres-backup-afternoon
    patch: |-
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/env/0/value
        value: "staging"
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/volumes/0/hostPath/path
        value: "/staging-goapps-backup/postgres"

  # Patch backup path for staging VPS - Night backup
  - target:
      kind: CronJob
      name: postgres-backup-night
    patch: |-
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/env/0/value
        value: "staging"
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/volumes/0/hostPath/path
        value: "/staging-goapps-backup/postgres"

  # ===== MinIO Backup Patches =====
  # Patch MinIO backup for staging environment
  - target:
      kind: CronJob
      name: minio-backup-to-disk
    patch: |-
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/env/0/value
        value: "staging"
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/volumes/0/hostPath/path
        value: "/staging-goapps-backup"
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/env/5/value
        value: "postgres-backups export-files goapps-staging"
