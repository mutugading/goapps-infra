# ============================================================================
# Combined Ingress - Path-Based Routing with TLS + Auth (PRODUCTION)
# ============================================================================
# 
# Akses via HTTPS (path-based):
# - Grafana:    https://goapps.mutugading.com/grafana
# - Prometheus: https://goapps.mutugading.com/prometheus (with Basic Auth)
# - MinIO:      https://goapps.mutugading.com/minio
#
# Akses via Port (direct - HTTP karena ArgoCD insecure mode):
# - ArgoCD:     http://goapps.mutugading.com:30080
# ============================================================================

---
# Grafana Ingress
# IMPORTANT: Grafana with serve_from_sub_path=true handles sub-path internally.
# DO NOT use rewrite-target, it will break the routing.
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # NO rewrite-target - Grafana handles /grafana internally
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - goapps.mutugading.com
      secretName: goapps-tls
  rules:
    - host: goapps.mutugading.com
      http:
        paths:
          - path: /grafana
            pathType: Prefix
            backend:
              service:
                name: prometheus-grafana
                port:
                  number: 80

---
# Prometheus Ingress (with Basic Auth for Production)
# Prometheus with routePrefix=/prometheus handles sub-path internally.
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prometheus-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Basic Auth for production security
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: prometheus-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "Prometheus - Authentication Required"
    # NO rewrite-target - Prometheus handles /prometheus internally
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - goapps.mutugading.com
      secretName: goapps-tls
  rules:
    - host: goapps.mutugading.com
      http:
        paths:
          - path: /prometheus
            pathType: Prefix
            backend:
              service:
                name: prometheus-kube-prometheus-prometheus
                port:
                  number: 9090

---
# MinIO Console Ingress
# MinIO with MINIO_BROWSER_REDIRECT_URL and MINIO_CONSOLE_SUBPATH handles sub-path.
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minio-ingress
  namespace: minio
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "1024m"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # NO rewrite-target - MinIO handles /minio internally via MINIO_CONSOLE_SUBPATH
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - goapps.mutugading.com
      secretName: goapps-tls
  rules:
    - host: goapps.mutugading.com
      http:
        paths:
          - path: /minio
            pathType: Prefix
            backend:
              service:
                name: minio
                port:
                  number: 9001  # Console port
